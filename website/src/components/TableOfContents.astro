---
/**
 * Table of Contents Component
 * Displays a sticky sidebar TOC for blog posts
 */
import type { MarkdownHeading } from 'astro'

interface Props {
  headings: MarkdownHeading[]
}

const { headings } = Astro.props

// Filter to only show h2 and h3 headings
const tocHeadings = headings.filter((h) => h.depth === 2 || h.depth === 3)
---

{
  tocHeadings.length > 0 && (
    <nav class='toc' aria-label='Table of Contents'>
      <h2 class='toc-title'>On This Page</h2>
      <ul class='toc-list'>
        {tocHeadings.map((heading) => (
          <li class={`toc-item depth-${heading.depth}`}>
            <a href={`#${heading.slug}`} class='toc-link'>
              {heading.text}
            </a>
          </li>
        ))}
      </ul>
    </nav>
  )
}

<style>
  .toc {
    position: sticky;
    top: 5rem;
    max-height: calc(100vh - 10rem);
    overflow-y: auto;
    padding: 1.5rem;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 12px;
    backdrop-filter: blur(10px);
  }

  .toc-title {
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--sl-color-text);
    margin: 0 0 1rem 0;
  }

  .toc-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .toc-item {
    margin: 0;
  }

  .toc-item.depth-2 {
    margin-bottom: 0.5rem;
  }

  .toc-item.depth-3 {
    padding-left: 1rem;
    margin-bottom: 0.25rem;
  }

  .toc-link {
    display: block;
    padding: 0.375rem 0.5rem;
    font-size: 0.875rem;
    line-height: 1.5;
    color: var(--sl-color-gray-3);
    text-decoration: none;
    border-left: 2px solid transparent;
    transition: all 0.2s ease;
  }

  .toc-link:hover {
    color: var(--sl-color-accent);
    border-left-color: var(--sl-color-accent);
    background: rgba(249, 115, 22, 0.05);
  }

  .toc-link.active {
    color: var(--sl-color-accent);
    border-left-color: var(--sl-color-accent);
    font-weight: 600;
  }

  /* Light mode */
  :root[data-theme='light'] .toc {
    background: rgba(255, 255, 255, 0.7);
  }

  /* Scrollbar styling */
  .toc::-webkit-scrollbar {
    width: 4px;
  }

  .toc::-webkit-scrollbar-track {
    background: transparent;
  }

  .toc::-webkit-scrollbar-thumb {
    background: var(--sl-color-gray-5);
    border-radius: 2px;
  }

  .toc::-webkit-scrollbar-thumb:hover {
    background: var(--sl-color-gray-4);
  }
</style>

<script>
  // Intersection Observer to highlight active section
  function setupTOC() {
    const tocLinks = document.querySelectorAll('.toc-link')
    if (tocLinks.length === 0) return

    const headings = document.querySelectorAll('h2[id], h3[id]')
    if (headings.length === 0) return

    const observerOptions = {
      rootMargin: '-80px 0px -80% 0px',
      threshold: 0,
    }

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        const id = entry.target.getAttribute('id')
        const tocLink = document.querySelector(`.toc-link[href="#${id}"]`)

        if (entry.isIntersecting && tocLink) {
          // Remove active class from all links
          tocLinks.forEach((link) => link.classList.remove('active'))
          // Add active class to current link
          tocLink.classList.add('active')
        }
      })
    }, observerOptions)

    headings.forEach((heading) => observer.observe(heading))
  }

  // Run on page load
  document.addEventListener('DOMContentLoaded', setupTOC)

  // Re-run on view transitions (if using Astro view transitions)
  document.addEventListener('astro:page-load', setupTOC)
</script>
