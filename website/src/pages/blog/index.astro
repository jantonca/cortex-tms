---
import { getCollection } from 'astro:content'
import SimpleLayout from '../../layouts/SimpleLayout.astro'
import BlogPostCard from '../../components/BlogPostCard.astro'

// Get all blog posts, filter out drafts, and sort by date
const allPosts = await getCollection('blog', ({ data }) => {
  return import.meta.env.PROD ? data.draft !== true : true
})

const posts = allPosts.sort((a, b) => {
  // Sort by date (newest first)
  const dateCompare = b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
  // If dates are equal, sort alphabetically by title
  if (dateCompare === 0) {
    return a.data.title.localeCompare(b.data.title)
  }
  return dateCompare
})
---

<SimpleLayout
  title='Blog'
  description='Latest updates, insights, and stories from the Cortex TMS team'
  lang='en'
  dir='ltr'
>
  {/* Ambient background gradients */}
  <div class='liquid-ambient-bg'></div>

  <div class='blog-container'>
    <p class='blog-intro'>
      Insights on AI-powered development, documentation patterns, and building
      maintainable software.
    </p>

    <div class='posts-grid glass-grid'>
      {
        posts.length === 0 ? (
          <p class='no-posts'>No blog posts yet. Check back soon!</p>
        ) : (
          posts.map((post) => {
            // Get first tag as category
            const category =
              post.data.tags && post.data.tags.length > 0
                ? post.data.tags[0]
                : undefined

            return (
              <BlogPostCard
                title={post.data.title}
                excerpt={post.data.description}
                heroImage={post.data.heroImage}
                category={category}
                pubDate={post.data.pubDate}
                slug={post.slug}
              />
            )
          })
        )
      }
    </div>
  </div>

  <style>
    .blog-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
      position: relative;
      z-index: 1;
    }

    .blog-intro {
      font-size: 1.125rem;
      color: var(--sl-color-gray-2);
      margin-bottom: 3rem;
      text-align: center;
      font-weight: 300;
      line-height: 1.6;
    }

    .posts-grid {
      gap: 2.5rem;
    }

    .no-posts {
      grid-column: 1 / -1;
      text-align: center;
      color: var(--sl-color-gray-3);
      padding: 3rem;
      font-size: 1.125rem;
    }

    @media (max-width: 768px) {
      .posts-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</SimpleLayout>
