# v3.2 Polish & Documentation Tasks

**Status**: üîµ Ready to Start
**Timeline**: Jan 31 - Feb 1, 2026 (Est. 9-12h total)
**Context**: Security implementation (AUDIT-1 to AUDIT-6) complete. Now polish for release.
**Driver**: GPT-5.1 feedback integration + v3.2.0 release preparation

---

## üéØ Overview

All 6 core security tasks are **complete**. This document covers the remaining polish and documentation work needed before v3.2.0 can be released.

**Current Status**:
- ‚úÖ AUDIT-1 to AUDIT-6 implemented
- ‚úÖ 283 tests passing (core functionality solid)
- ‚úÖ Direct validation passes
- ‚ùå 31 E2E test failures (test fixture issues)
- ‚ö†Ô∏è Documentation gaps prevent release

---

## üìã Phase 1: Critical (P0) - Required for Release

### POLISH-1: Fix E2E Test Failures (2-3h)

**Problem**: 31 failing E2E tests block release confidence.

**Root Cause** (GPT-5.1 analysis): Systemic assertion pattern issue.

**Strategy**:
1. **Triage failures** into categories:
   - Test bugs (over-strict expectations)
   - Fixture drift (CLI changed, test outdated)
   - Real regressions (actual CLI bugs)

2. **Fix systemic issues first**:
   ```typescript
   // ‚ùå Wrong: Doesn't actually check either/or
   expect(result.stdout).toContain('Migration complete') ||
     expect(result.stdout).toContain('Successfully migrated')

   // ‚úÖ Right: Proper either/or check
   expect(
     result.stdout.includes('Migration complete') ||
     result.stdout.includes('Successfully migrated')
   ).toBe(true)
   ```
   This pattern appears in multiple test files and causes most failures.

3. **Harden high-value tests**:
   - `review` E2E: Assert specific messages (API key errors, JSON output)
   - Ensure no real network calls (skip/mock when no API key)
   - Add specific assertions vs vague "there was output"

**Files to Fix**:
- `src/__tests__/init-e2e.test.ts`
- `src/__tests__/validate-e2e.test.ts`
- `src/__tests__/migrate-e2e.test.ts`
- `src/__tests__/review-e2e.test.ts`

**Success Criteria**:
- [ ] All E2E tests pass (0 failures)
- [ ] Systemic assertion issues fixed
- [ ] No real network calls in test suite
- [ ] Categorized any real regressions (if found)

---

### POLISH-2: CHANGELOG.md (3.2.0 - Unreleased) (1h)

**Goal**: Create structured v3.2.0 release notes.

**Structure** (GPT-5.1 recommendation):
```markdown
## [3.2.0] - Unreleased

### Security
- Centralized error handling (AUDIT-1)
  - Removed all `process.exit()` calls from src/
  - Consistent `CLIError` hierarchy for all commands
- Zod-based input validation for all commands (AUDIT-2)
  - Type-safe CLI options with runtime validation
  - Clear error messages for invalid inputs
- Path traversal protection for templates and migrations (AUDIT-5)
  - `validateSafePath()` prevents `../../etc/passwd` attacks
  - All file operations validated at boundaries
- API key redaction in Guardian logs and errors (AUDIT-6)
  - Anthropic API keys sanitized in all output paths
  - Safe error reporting without credential leaks

### Testing
- Added 60+ E2E tests for init, validate, migrate, review (AUDIT-3)
  - Full CLI workflow coverage
  - Temp directory isolation
  - No network dependencies
- Security-focused unit tests and integration tests
  - Path traversal attack tests
  - Error handling edge cases
  - Validation boundary tests

### Tooling & CI
- CI now runs `pnpm audit --audit-level=high --prod` on every PR (AUDIT-4)
  - Automated vulnerability scanning
  - Blocks PRs with high-severity issues
  - Production dependencies only

### Documentation
- Error handling patterns documented in `docs/core/PATTERNS.md`
- New Security Testing Guide (`docs/guides/SECURITY-TESTING.md`)
- API documentation for CLI and developer usage
- Updated migration guide for v3.2 upgrade path

### Improvements (Rolled from v3.1.1)
- Git repo detection fix (subdirectory support)
- E2E integration tests for auto-tier (16 tests)
- Validation display bug fix (placeholder errors)
- Integration test updates (7 tests)
```

**Important**: Keep as "Unreleased" until ready to publish. Only change date when:
- All tests pass
- Documentation complete
- Ready to `npm publish`

**Success Criteria**:
- [ ] CHANGELOG.md has structured 3.2.0 section
- [ ] All AUDIT tasks referenced in human-readable terms
- [ ] v3.1.1 improvements included
- [ ] Section remains "Unreleased" until publish time

---

### POLISH-3: Document Error Patterns in PATTERNS.md (1h)

**Goal**: Turn security work into reusable patterns for future contributors.

**Additions to `docs/core/PATTERNS.md`**:

#### Pattern: Centralized CLI Error Handling

**Intent**: Consistent error behavior across all commands without process crashes.

**Motivation**: AUDIT-1 found scattered `process.exit()` calls that:
- Made testing impossible (can't catch process exit)
- Inconsistent error messages
- No error recovery or cleanup

**Implementation**:
```typescript
// src/utils/errors.ts
export class CLIError extends Error {
  constructor(
    message: string,
    public exitCode: number = 1,
    public details?: unknown
  ) {
    super(message);
    this.name = 'CLIError';
  }
}

export class ValidationError extends CLIError {
  constructor(message: string, details?: unknown) {
    super(message, 1, details);
    this.name = 'ValidationError';
  }
}

// Command handler
async function myCommand(options: Options): Promise<void> {
  if (!isValid(options)) {
    throw new ValidationError('Invalid options', { options });
  }
  // Command logic
}
```

**How to Apply**:
- ‚úÖ DO throw `CLIError` or subclasses from command handlers
- ‚úÖ DO let the bin entry point catch and format errors
- ‚ùå DON'T call `process.exit()` in src/ (only bin/cortex-tms.js)
- ‚ùå DON'T use `console.error()` directly (use error classes)

**Cross-Links**:
- See: `docs/core/SECURITY.md` for high-level security overview
- See: `docs/guides/SECURITY-TESTING.md` for testing error patterns

---

#### Pattern: Validated Input Pipeline (Zod + Safe Paths)

**Intent**: Type-safe, validated inputs at command boundaries.

**Motivation**: AUDIT-2 and AUDIT-5 found:
- No runtime validation of CLI options
- Unsafe path handling (directory traversal risk)
- Inconsistent input sanitization

**Implementation**:
```typescript
// 1. Define schema with Zod
import { z } from 'zod';

const MigrateOptionsSchema = z.object({
  target: z.string().min(1),
  dryRun: z.boolean().optional(),
  force: z.boolean().optional(),
});

// 2. Validate at command entry
export async function migrate(options: unknown): Promise<void> {
  const validated = validateOptions(MigrateOptionsSchema, options);

  // 3. Validate paths before filesystem operations
  const safePath = validateSafePath(validated.target, process.cwd());

  // Now safe to use
  await fs.readFile(safePath, 'utf-8');
}
```

**How to Apply**:
- ‚úÖ DO define Zod schemas for all command options
- ‚úÖ DO call `validateOptions()` at command entry points
- ‚úÖ DO use `validateSafePath()` before any filesystem operations
- ‚úÖ DO validate at boundaries (user input, external APIs)
- ‚ùå DON'T trust user input without validation
- ‚ùå DON'T construct file paths from user input directly

**Mitigation Note**: `validateSafePath()` is defense-in-depth, not bulletproof. Always:
- Validate paths are within expected directories
- Use allowlists for template names when possible
- Log path validation failures for security monitoring

**Cross-Links**:
- See: `docs/core/SECURITY.md` for threat model
- See: `docs/guides/API.md` for Zod schema examples

---

**Success Criteria**:
- [ ] Two new patterns added to PATTERNS.md
- [ ] Each pattern has: Intent / Motivation / Implementation / How to Apply
- [ ] Cross-links to SECURITY.md and SECURITY-TESTING.md
- [ ] Code examples are clear and actionable

---

### POLISH-4: Create SECURITY-TESTING.md Guide (1-2h)

**Goal**: Maintainable security posture through documented testing practices.

**File**: `docs/guides/SECURITY-TESTING.md`

**Structure** (GPT-5.1 recommendations):

```markdown
# Security Testing Guide

## Overview

This guide explains how to run security tests and checks for Cortex TMS. Use this to verify security patterns are upheld during development.

---

## üîç What to Run

### CI Pipeline (Automated)

These run automatically on every PR:
- `pnpm test` - All unit, integration, and E2E tests
- `pnpm run audit` - Dependency vulnerability scanning
- `pnpm run build` - TypeScript compilation checks

### Local Development (Manual)

Before committing code:
```bash
# Run all tests
pnpm test

# Run only E2E tests
pnpm test src/__tests__/*-e2e.test.ts

# Check dependencies
pnpm run audit

# Validate project structure
node bin/cortex-tms.js validate --strict
```

---

## üß™ E2E Test Suite

### How E2E Tests Work

- **Isolation**: Each test uses temp directories (`/tmp/cortex-test-*`)
- **No Network**: Tests don't make real API calls
- **Full CLI**: Tests invoke `bin/cortex-tms.js` like real users

### Running E2E Tests Safely

```bash
# Run all E2E tests
pnpm test src/__tests__/init-e2e.test.ts
pnpm test src/__tests__/validate-e2e.test.ts
pnpm test src/__tests__/migrate-e2e.test.ts
pnpm test src/__tests__/review-e2e.test.ts

# Run specific test
pnpm test src/__tests__/init-e2e.test.ts -t "should create nano scope"
```

**Important**: E2E tests:
- Don't touch your real project files
- Don't require API keys (Guardian tests skip if `ANTHROPIC_API_KEY` not set)
- Clean up temp directories automatically

### Skipped Tests

Some tests are skipped by default:
- Guardian tests without `ANTHROPIC_API_KEY` environment variable
- Tests marked with `.skip` or `.todo`

To enable Guardian tests:
```bash
export ANTHROPIC_API_KEY="your-key-here"
pnpm test src/__tests__/review-e2e.test.ts
```

---

## üîê Guardian / API Key Safety

### Setting API Keys Locally

```bash
# Option 1: Environment variable
export ANTHROPIC_API_KEY="sk-ant-..."

# Option 2: .env file (NOT committed to git)
echo "ANTHROPIC_API_KEY=sk-ant-..." > .env
```

### API Key Sanitization

Cortex TMS sanitizes API keys in **all output paths**:
- Logs
- Error messages
- Stack traces
- JSON output

**Example**:
```typescript
// Raw error (what LLM sees)
Error: API call failed with key sk-ant-api03-abc123...

// Sanitized output (what gets logged)
Error: API call failed with key [REDACTED]
```

**Important**: Even with sanitization:
- ‚úÖ DO use `.env` files for API keys (in `.gitignore`)
- ‚úÖ DO rotate keys if accidentally committed
- ‚ùå DON'T commit `.env` files to git
- ‚ùå DON'T hardcode keys in source files

---

## üõ°Ô∏è Security Patterns to Test

### 1. Error Handling

**What to test**:
- Commands throw `CLIError` (not `process.exit()`)
- Error messages are user-friendly
- Error details don't leak sensitive info

**Example test**:
```typescript
it('should throw CLIError on validation failure', async () => {
  await expect(validate({ invalid: true })).rejects.toThrow(CLIError);
});
```

### 2. Input Validation

**What to test**:
- Zod schemas reject invalid inputs
- Safe paths prevent directory traversal
- Template names are allowlisted

**Example test**:
```typescript
it('should reject path traversal attempts', () => {
  expect(() => validateSafePath('../../etc/passwd', '/tmp'))
    .toThrow(ValidationError);
});
```

### 3. Guardian Sanitization

**What to test**:
- API keys redacted in error messages
- API keys redacted in JSON output
- Logs don't contain sensitive data

**Example test**:
```typescript
it('should sanitize API keys in errors', () => {
  const error = new Error('Failed with key sk-ant-abc123');
  const sanitized = sanitizeError(error);
  expect(sanitized.message).toContain('[REDACTED]');
  expect(sanitized.message).not.toContain('sk-ant-');
});
```

---

## üö® What to Do When Tests Fail

### `pnpm audit` Fails

**Symptoms**: CI shows "High severity vulnerabilities found"

**Action**:
1. Check `pnpm audit` output for details
2. Update vulnerable packages: `pnpm update`
3. If no fix available, check `docs/core/SECURITY.md` for mitigation
4. Create issue for tracking

### E2E Tests Fail

**Symptoms**: CLI commands don't behave as expected

**Debug steps**:
1. Check test output for stdout/stderr
2. Inspect temp directory (path shown in error)
3. Run command manually to reproduce
4. Check if assertion pattern is correct (either/or issues)

**Common issues**:
```typescript
// ‚ùå Wrong: Doesn't work as either/or
expect(stdout).toContain('A') || expect(stdout).toContain('B')

// ‚úÖ Right: Proper either/or
expect(stdout.includes('A') || stdout.includes('B')).toBe(true)
```

### `validate --strict` Fails

**Symptoms**: "Validation failed" with error count

**Debug steps**:
1. Run `node bin/cortex-tms.js validate --strict` to see details
2. Check mandatory files exist:
   - `NEXT-TASKS.md`
   - `CLAUDE.md`
   - `.github/copilot-instructions.md`
3. Check `.cortexrc` configuration
4. Review `docs/core/ARCHITECTURE.md` for project structure

---

## üìö Related Documentation

- **High-level security**: `docs/core/SECURITY.md`
- **Security patterns**: `docs/core/PATTERNS.md` (Error Handling, Input Validation)
- **API documentation**: `docs/guides/API.md` (Zod schemas, error types)
- **Contributing**: `CONTRIBUTING.md` (test requirements for PRs)

---

## ‚úÖ Pre-Release Checklist

Before releasing a new version, verify:

- [ ] All tests pass (`pnpm test`)
- [ ] No high-severity vulnerabilities (`pnpm run audit`)
- [ ] Build succeeds (`pnpm run build`)
- [ ] Validation passes (`node bin/cortex-tms.js validate --strict`)
- [ ] E2E tests cover new features
- [ ] Security patterns documented (if new patterns added)
- [ ] CHANGELOG.md updated with security changes
- [ ] README.md links to security docs

---

**Last Updated**: 2026-01-31 (v3.2.0 Polish Sprint)
```

**Cross-Linking**:
After creating this file, update:
- `README.md` - Add link in "Contributing" section
- `docs/core/SECURITY.md` - Add link to testing guide
- `docs/core/PATTERNS.md` - Reference testing guide in pattern docs

**Success Criteria**:
- [ ] SECURITY-TESTING.md created with all sections
- [ ] Covers: CI vs local, E2E safety, Guardian safety, troubleshooting
- [ ] Linked from README.md and SECURITY.md
- [ ] Includes pre-release checklist

---

### POLISH-5: Sync NEXT-TASKS.md + Archive Sprint (30m)

**Goal**: Keep source of truth aligned with code state.

**Actions**:
1. **Update NEXT-TASKS.md**:
   - Mark all AUDIT tasks as ‚úÖ Complete
   - Update Documentation success criteria checkboxes
   - Update "Last Updated" date
   - Add reference to this detailed plan doc

2. **Archive v3.2 sprint**:
   - Create `docs/archive/sprint-v3.2-jan-2026.md`
   - Move detailed task descriptions from NEXT-TASKS.md
   - Keep NEXT-TASKS.md under 200 lines
   - Follow existing archive format (see sprint-v3.1-jan-2026.md)

3. **Update sprint archive list**:
   - Add v3.2 to archive section at bottom of NEXT-TASKS.md

**Success Criteria**:
- [ ] NEXT-TASKS.md updated and under 200 lines
- [ ] v3.2 sprint archived in docs/archive/
- [ ] All success criteria checkboxes accurate
- [ ] References to detailed plan doc added

---

## üìã Phase 2: Quality (P1) - Recommended Before Release

### POLISH-6: README Polish (30m)

**Goal**: Highlight v3.2 security features for first-time visitors.

**Additions**:

1. **"What's New in 3.2 (upcoming)" section**:
   ```markdown
   ## üÜï What's New in v3.2 (Upcoming)

   **Security & Production Readiness**:
   - üõ°Ô∏è Centralized error handling (no more process crashes)
   - ‚úÖ Zod-based input validation for all commands
   - üß™ 60+ E2E tests for full CLI workflow coverage
   - üîí Path traversal protection and API key sanitization
   - üìä Automated dependency vulnerability scanning in CI

   See [CHANGELOG.md](CHANGELOG.md) for full release notes.
   ```

2. **Update security section** (if exists):
   - Link to `docs/core/SECURITY.md`
   - Link to `docs/guides/SECURITY-TESTING.md`
   - Mention Guardian API key safety

3. **Update stats** (if needed):
   - Test count: 316+ tests
   - E2E coverage: init, validate, migrate, review

**Success Criteria**:
- [ ] "What's New" section added
- [ ] Security docs linked
- [ ] Stats updated
- [ ] No breaking changes to existing content

---

### POLISH-7: Migration Guide (30m)

**Goal**: Help existing users upgrade safely to v3.2.

**File**: `docs/guides/MIGRATION-GUIDE.md`

**Add "Upgrading to v3.2.0" section**:

```markdown
## Upgrading to v3.2.0

### Overview

v3.2.0 is a **security and testing** release. No breaking changes to CLI usage, but improved validation may catch issues that previously passed silently.

### What Changed

**Security Improvements**:
- All commands now use centralized error handling
- Input validation is stricter (Zod schemas)
- Path operations validated to prevent directory traversal
- Guardian API keys sanitized in all output

**Testing**:
- 60+ new E2E tests
- CI includes automated vulnerability scanning

### Migration Steps

1. **Update package**:
   ```bash
   npm install -g cortex-tms@3.2.0
   # or
   pnpm add -D cortex-tms@3.2.0
   ```

2. **Run validation**:
   ```bash
   cortex-tms validate --strict
   ```
   This will catch any project structure issues that now fail validation.

3. **Update templates** (if needed):
   ```bash
   cortex-tms migrate
   ```
   Follow prompts to update to latest template versions.

4. **Check for stricter validation**:
   If you were passing invalid options to commands (e.g., wrong types, missing required fields), v3.2.0 will now catch these at runtime.

### Breaking Changes

**None**. v3.2.0 is backward-compatible with v3.1.x.

**Behavioral Changes**:
- Commands now exit cleanly with error messages instead of process crashes
- Invalid CLI options now fail fast with clear Zod validation errors
- Path operations outside project directory are rejected

### If You Encounter Issues

1. Check error message (now more descriptive with Zod validation)
2. Run `cortex-tms validate --strict` to check project health
3. See `docs/guides/SECURITY-TESTING.md` for troubleshooting
4. Open issue: https://github.com/cortex-tms/cortex-tms/issues

### Recommended Follow-Up

After upgrading:
- Review `docs/core/PATTERNS.md` for new error handling patterns
- Read `docs/guides/SECURITY-TESTING.md` if contributing
- Update your CI to include `pnpm audit` checks
```

**Success Criteria**:
- [ ] "Upgrading to v3.2.0" section added
- [ ] Migration steps clear and actionable
- [ ] Breaking changes documented (none expected)
- [ ] Troubleshooting guidance included

---

### POLISH-8: API Documentation (1-2h)

**Goal**: Document CLI and developer API for tools/Skills integration.

**File**: `docs/guides/API.md` (create if doesn't exist)

**Structure**:

```markdown
# Cortex TMS API Documentation

## Overview

This document covers both the **CLI API** (for users and automation) and **Developer API** (for embedding Cortex TMS in tools).

---

## CLI API

### Commands

#### `cortex-tms init`

Initializes a new Cortex TMS project.

**Usage**:
```bash
cortex-tms init [options]
```

**Options**:
- `--scope <nano|standard|enterprise>` - Project scope (default: interactive)
- `--name <string>` - Project name (default: current directory)

**Exit Codes**:
- `0` - Success
- `1` - Validation error or user cancellation

**Example**:
```bash
cortex-tms init --scope nano --name my-project
```

#### `cortex-tms validate`

Validates project structure and TMS configuration.

**Usage**:
```bash
cortex-tms validate [options]
```

**Options**:
- `--strict` - Fail on warnings (default: false)

**Exit Codes**:
- `0` - Validation passed
- `1` - Validation failed

**Example**:
```bash
cortex-tms validate --strict
```

#### `cortex-tms review` (Guardian)

AI-powered code review using Claude.

**Usage**:
```bash
cortex-tms review <file> [options]
```

**Options**:
- `--output-json` - Output raw JSON (for automation)
- `--safe` - Only show high-confidence violations (>= 70%)
- `--provider <anthropic>` - AI provider (default: anthropic)
- `--model <string>` - Model name (default: claude-sonnet-4-5-20250929)

**Exit Codes**:
- `0` - Review completed (violations may exist)
- `1` - Error (missing API key, file not found, etc.)

**Example**:
```bash
# Human-readable output
cortex-tms review src/file.ts

# JSON output for automation
cortex-tms review src/file.ts --output-json | jq '.violations | length'

# Safe mode (high-confidence only)
cortex-tms review src/file.ts --safe
```

**Environment Variables**:
- `ANTHROPIC_API_KEY` - Required for Guardian

---

## Developer API

### Error Handling

**CLIError Hierarchy**:
```typescript
class CLIError extends Error {
  exitCode: number;
  details?: unknown;
}

class ValidationError extends CLIError {
  // exitCode = 1
}

class FileNotFoundError extends CLIError {
  // exitCode = 1
}
```

**Usage in Commands**:
```typescript
import { CLIError, ValidationError } from './utils/errors';

async function myCommand(options: Options): Promise<void> {
  if (!isValid(options)) {
    throw new ValidationError('Invalid options', { options });
  }
  // Command logic
}
```

**Error Handling in Bin**:
```typescript
// bin/cortex-tms.js
try {
  await command(options);
  process.exit(0);
} catch (error) {
  if (error instanceof CLIError) {
    console.error(error.message);
    process.exit(error.exitCode);
  }
  throw error; // Unexpected error
}
```

---

### Input Validation (Zod)

**Defining Schemas**:
```typescript
import { z } from 'zod';
import { validateOptions } from './utils/validation';

const MigrateOptionsSchema = z.object({
  target: z.string().min(1),
  dryRun: z.boolean().optional().default(false),
  force: z.boolean().optional().default(false),
});

type MigrateOptions = z.infer<typeof MigrateOptionsSchema>;
```

**Validating at Command Entry**:
```typescript
export async function migrate(rawOptions: unknown): Promise<void> {
  const options = validateOptions(MigrateOptionsSchema, rawOptions);
  // options is now type-safe and validated
}
```

**Custom Validation Rules**:
```typescript
const CustomSchema = z.object({
  email: z.string().email(),
  age: z.number().min(0).max(120),
  role: z.enum(['admin', 'user']),
});
```

---

### Path Safety

**Validating Safe Paths**:
```typescript
import { validateSafePath } from './utils/path-validation';

// Prevent directory traversal
const userPath = options.file; // Could be "../../etc/passwd"
const safePath = validateSafePath(userPath, process.cwd());
// Throws ValidationError if path escapes base directory

// Now safe to use
await fs.readFile(safePath, 'utf-8');
```

**Implementation**:
```typescript
function validateSafePath(inputPath: string, baseDir: string): string {
  const resolved = path.resolve(baseDir, inputPath);
  if (!resolved.startsWith(baseDir)) {
    throw new ValidationError(`Path outside base directory: ${inputPath}`);
  }
  return resolved;
}
```

---

### Guardian (LLM Client)

**API Key Sanitization**:
```typescript
import { sanitizeForLogging } from './utils/llm-client';

try {
  await callAnthropicAPI(apiKey, prompt);
} catch (error) {
  // Sanitize before logging
  const safeError = sanitizeForLogging(error);
  console.error(safeError); // API key redacted
}
```

**JSON Output Mode**:
```typescript
// Guardian returns GuardianResult
interface GuardianResult {
  violations: Violation[];
  summary: string;
  metadata: {
    model: string;
    timestamp: string;
  };
}

// Access in code
const result = await runGuardian(file, options);
if (options.outputJson) {
  console.log(JSON.stringify(result, null, 2));
} else {
  formatForHumans(result);
}
```

---

## Embedding Cortex TMS

### Use Case: CI/CD Pipeline

```bash
#!/bin/bash
# .github/workflows/cortex-validate.yml

# Install Cortex TMS
npm install -g cortex-tms

# Validate project
if ! cortex-tms validate --strict; then
  echo "Validation failed"
  exit 1
fi

# Run Guardian on changed files
for file in $(git diff --name-only HEAD~1); do
  cortex-tms review "$file" --safe --output-json | jq '.violations | length'
done
```

### Use Case: Anthropic Agent Skill

```typescript
// Skill definition
{
  "name": "cortex-guardian",
  "description": "Review code with Guardian",
  "command": "cortex-tms review {{file}} --output-json --safe",
  "parser": "json"
}

// Agent usage
const result = await executeSkill('cortex-guardian', { file: 'src/app.ts' });
const violationCount = result.violations.length;
```

---

## Type Definitions

```typescript
// Validation Options
interface ValidateOptions {
  strict?: boolean;
}

// Review Options
interface ReviewOptions {
  outputJson?: boolean;
  safe?: boolean;
  provider?: 'anthropic';
  model?: string;
}

// Guardian Result
interface Violation {
  type: string;
  severity: 'low' | 'medium' | 'high';
  message: string;
  line?: number;
  confidence?: number; // 0-1 scale
}

interface GuardianResult {
  violations: Violation[];
  summary: string;
  metadata: {
    model: string;
    timestamp: string;
  };
}
```

---

## Error Reference

| Error Type | Exit Code | Typical Cause |
|------------|-----------|---------------|
| `ValidationError` | 1 | Invalid CLI options or project structure |
| `FileNotFoundError` | 1 | Missing required file |
| `CLIError` | 1 | General command failure |
| Uncaught exception | 1 | Unexpected error (bug) |

---

## Related Documentation

- **Security Testing**: `docs/guides/SECURITY-TESTING.md`
- **Error Patterns**: `docs/core/PATTERNS.md`
- **Migration Guide**: `docs/guides/MIGRATION-GUIDE.md`

---

**Last Updated**: 2026-01-31 (v3.2.0 API documentation)
```

**Success Criteria**:
- [ ] API.md created with CLI and Developer API sections
- [ ] All commands documented (flags, exit codes, examples)
- [ ] Zod schemas and error types explained
- [ ] Guardian JSON output documented
- [ ] Embedding examples (CI/CD, Agent Skills)

---

### POLISH-9: Tutorial Update (1h)

**Goal**: Update interactive tutorial to showcase v3.2 features.

**File**: `src/commands/tutorial.ts` (or wherever tutorial content lives)

**Additions**:

1. **Validation Example**:
   ```
   Step 3: Validate Your Project

   Run: cortex-tms validate --strict

   This checks:
   - Mandatory files exist (NEXT-TASKS.md, CLAUDE.md, etc.)
   - Project structure follows Cortex patterns
   - Configuration is valid

   Try it now! If validation fails, you'll see clear error messages
   explaining what's missing.
   ```

2. **Error Handling Example**:
   ```
   Step 5: Understanding Errors

   Cortex TMS uses consistent error messages. Try this invalid command:

   cortex-tms init --scope invalid

   You'll see:
   ‚ùå Invalid scope: "invalid"
      Expected one of: nano, standard, enterprise

   All commands now have:
   - Clear validation errors
   - Helpful suggestions
   - No process crashes
   ```

3. **Guardian Example** (optional):
   ```
   Step 7: Code Review with Guardian

   Set your Anthropic API key:
   export ANTHROPIC_API_KEY="your-key-here"

   Review a file:
   cortex-tms review src/example.ts

   Guardian will analyze your code and suggest improvements.
   Use --safe flag to only see high-confidence violations.
   ```

**Success Criteria**:
- [ ] Tutorial updated with validation example
- [ ] Error handling demonstrated
- [ ] Optional Guardian example (if tutorial supports it)
- [ ] Tutorial flows naturally with new content

---

### POLISH-10: Contributor Quickstart (20m)

**Goal**: Make it easy for contributors to run tests and security checks.

**File**: `README.md` or `CONTRIBUTING.md` (whichever exists)

**Add section**:

```markdown
## Running Tests & Security Checks

**Quick start for contributors**:

```bash
# Run all tests
pnpm test

# Run only E2E tests
pnpm test src/__tests__/*-e2e.test.ts

# Check for vulnerabilities
pnpm run audit

# Validate project structure
node bin/cortex-tms.js validate --strict

# Build
pnpm run build
```

**Before submitting a PR**:
- ‚úÖ All tests pass
- ‚úÖ No high-severity vulnerabilities
- ‚úÖ Build succeeds
- ‚úÖ Code follows patterns in `docs/core/PATTERNS.md`

**Detailed testing guide**: See `docs/guides/SECURITY-TESTING.md`

**Security concerns**: See `docs/core/SECURITY.md`
```

**Success Criteria**:
- [ ] Quickstart section added to README or CONTRIBUTING
- [ ] Links to detailed docs (SECURITY-TESTING.md, SECURITY.md, PATTERNS.md)
- [ ] Commands are copy-paste ready
- [ ] PR checklist included

---

## üìã Phase 3: Excellence (P2) - Post-Release / Marketing

### POLISH-11: Code Examples (2h)

**Goal**: Provide working demos of security patterns.

**Create**: `examples/security/` directory

**Examples to create**:

1. **bad-error-handling.ts**:
   ```typescript
   // ‚ùå Bad: Direct process.exit()
   if (!isValid) {
     console.error('Invalid!');
     process.exit(1); // Can't test, can't catch
   }
   ```

2. **good-error-handling.ts**:
   ```typescript
   // ‚úÖ Good: Throw CLIError
   if (!isValid) {
     throw new ValidationError('Invalid input', { details });
   }
   ```

3. **path-traversal-attack.ts**:
   ```typescript
   // ‚ùå Vulnerable
   const userPath = req.query.file; // "../../etc/passwd"
   await fs.readFile(userPath); // DANGER!

   // ‚úÖ Safe
   const safePath = validateSafePath(userPath, baseDir);
   await fs.readFile(safePath); // Throws if outside baseDir
   ```

4. **guardian-integration.ts**:
   ```typescript
   // Complete example: Guardian with env var
   import { runGuardian } from 'cortex-tms';

   const apiKey = process.env.ANTHROPIC_API_KEY;
   if (!apiKey) {
     throw new Error('ANTHROPIC_API_KEY required');
   }

   const result = await runGuardian('src/file.ts', {
     safe: true,
     outputJson: true,
   });

   console.log(`Found ${result.violations.length} violations`);
   ```

**README in examples/security/**:
```markdown
# Security Examples

Working code examples demonstrating Cortex TMS security patterns.

## Running Examples

```bash
cd examples/security
npm install
npm run example:errors
npm run example:paths
npm run example:guardian
```

## Files

- `bad-error-handling.ts` - Anti-patterns to avoid
- `good-error-handling.ts` - Correct error handling
- `path-traversal-attack.ts` - Safe path validation
- `guardian-integration.ts` - Using Guardian programmatically
```

**Success Criteria**:
- [ ] examples/security/ directory created
- [ ] At least 3 examples (errors, paths, Guardian)
- [ ] Each example has bad vs good comparison
- [ ] README explains how to run examples

---

### POLISH-12: Test Runtime Guide (1h)

**Goal**: Document how to run test subsets and typical runtimes.

**File**: Add to `docs/guides/SECURITY-TESTING.md` or create separate `TEST-GUIDE.md`

**Content**:

```markdown
## Test Runtime Guide

### Test Suites

Cortex TMS has 316+ tests across three categories:

| Suite | Count | Runtime | Command |
|-------|-------|---------|---------|
| Unit Tests | 200+ | ~10s | `pnpm test src/__tests__/unit/` |
| Integration Tests | 50+ | ~15s | `pnpm test src/__tests__/integration/` |
| E2E Tests | 60+ | ~25s | `pnpm test src/__tests__/*-e2e.test.ts` |
| **All Tests** | **316+** | **~50s** | `pnpm test` |

### Running Subsets

**By file**:
```bash
pnpm test src/__tests__/init-e2e.test.ts
```

**By test name**:
```bash
pnpm test -t "should create nano scope"
```

**By pattern**:
```bash
pnpm test --grep "validation"
```

### Parallel Execution

Tests run in parallel by default (4 workers). To run sequentially:
```bash
pnpm test --no-parallel
```

### Performance Tips

- Run unit tests only during development (fastest feedback)
- Run E2E tests before committing (full coverage)
- CI runs all tests on every PR
```

**Success Criteria**:
- [ ] Test runtime guide added
- [ ] Shows how to run subsets efficiently
- [ ] Typical runtimes documented
- [ ] Performance tips included

---

### POLISH-13: Video Tutorial (2h)

**Goal**: 5-minute walkthrough of v3.2 security features.

**Topics to cover**:
1. Security overview (30s)
2. Centralized error handling demo (1m)
3. Input validation with Zod (1m)
4. E2E test suite walkthrough (1.5m)
5. Guardian API key safety (1m)

**Deliverables**:
- [ ] Screen recording of CLI demos
- [ ] Voiceover script
- [ ] Upload to YouTube
- [ ] Embed in README or website

---

### POLISH-14: Blog Post Draft (2-3h)

**Goal**: "How We Secured Cortex TMS" for launch announcement.

**Outline**:
1. **The Problem** (200 words)
   - Rapid development left security gaps
   - Opus 4.5 audit revealed 6 critical issues
   - Production readiness blocked

2. **The Solution** (600 words)
   - AUDIT-1: Centralized error handling
   - AUDIT-2: Zod validation
   - AUDIT-3: E2E test suite
   - AUDIT-4: CI dependency scanning
   - AUDIT-5: Path traversal protection
   - AUDIT-6: API key redaction

3. **The Results** (200 words)
   - 316+ tests passing
   - Zero process crashes
   - Production-ready security posture
   - Clear upgrade path for users

4. **Lessons Learned** (200 words)
   - Security as a feature, not afterthought
   - Testing patterns prevent regressions
   - Documentation makes security maintainable

**Deliverables**:
- [ ] Draft blog post (1200 words)
- [ ] Code examples and screenshots
- [ ] Ready to publish on launch day

---

## üìä Summary

### Time Estimates

| Phase | Tasks | Effort | Priority |
|-------|-------|--------|----------|
| **Phase 1** (Critical) | POLISH-1 to POLISH-5 | 5.5-7.5h | P0 |
| **Phase 2** (Quality) | POLISH-6 to POLISH-10 | 3.3-4.3h | P1 |
| **Phase 3** (Excellence) | POLISH-11 to POLISH-14 | 7-8h | P2 |
| **Total** | 14 tasks | **16-20h** | - |

### Recommended Sequence

```
Day 1 (Phase 1 - Critical)
‚îú‚îÄ POLISH-1: Fix E2E tests ........................... 2-3h
‚îú‚îÄ POLISH-2: CHANGELOG.md ............................ 1h
‚îú‚îÄ POLISH-3: Error patterns (PATTERNS.md) ............ 1h
‚îú‚îÄ POLISH-4: SECURITY-TESTING.md ..................... 1-2h
‚îî‚îÄ POLISH-5: Sync NEXT-TASKS.md + archive ............ 30m
                                              Total: 5.5-7.5h

Day 2 (Phase 2 - Quality)
‚îú‚îÄ POLISH-6: README polish ........................... 30m
‚îú‚îÄ POLISH-7: Migration guide ......................... 30m
‚îú‚îÄ POLISH-8: API documentation ....................... 1-2h
‚îú‚îÄ POLISH-9: Tutorial updates ........................ 1h
‚îî‚îÄ POLISH-10: Contributor quickstart ................. 20m
                                              Total: 3.3-4.3h

Later (Phase 3 - Excellence)
‚îú‚îÄ POLISH-11: Code examples .......................... 2h
‚îú‚îÄ POLISH-12: Test runtime guide ..................... 1h
‚îú‚îÄ POLISH-13: Video tutorial ......................... 2h
‚îî‚îÄ POLISH-14: Blog post draft ........................ 2-3h
                                              Total: 7-8h
```

### Success Criteria

**Phase 1 Complete** means:
- ‚úÖ All tests pass (0 failures)
- ‚úÖ CHANGELOG.md has structured 3.2.0 section
- ‚úÖ Error patterns documented
- ‚úÖ Security testing guide published
- ‚úÖ NEXT-TASKS.md synced and archived

**Phase 2 Complete** means:
- ‚úÖ README highlights v3.2 features
- ‚úÖ Migration guide helps users upgrade
- ‚úÖ API documentation for automation
- ‚úÖ Tutorial showcases security
- ‚úÖ Contributors know how to run tests

**Phase 3 Complete** means:
- ‚úÖ Working code examples
- ‚úÖ Test runtime documented
- ‚úÖ Video tutorial published
- ‚úÖ Blog post ready for launch

---

## üîó Cross-References

**Primary Documents**:
- `NEXT-TASKS.md` - Sprint task list (condensed)
- `CHANGELOG.md` - Release notes
- `README.md` - Project overview

**Core Documentation**:
- `docs/core/SECURITY.md` - Security overview
- `docs/core/PATTERNS.md` - Error handling and validation patterns
- `docs/core/ARCHITECTURE.md` - System architecture

**Guides**:
- `docs/guides/SECURITY-TESTING.md` - Testing practices
- `docs/guides/API.md` - CLI and developer API
- `docs/guides/MIGRATION-GUIDE.md` - Upgrade instructions

**Archives**:
- `docs/archive/sprint-v3.2-jan-2026.md` - Full sprint retrospective (created when done)

---

**Last Updated**: 2026-01-31
**Status**: Ready for execution
**Feedback**: Integrated GPT-5.1 recommendations
